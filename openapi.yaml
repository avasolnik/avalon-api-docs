openapi: 3.1.0
info:
  title: Charge Planning Optimizer API
  version: 1.1.0
  description: >
    The Charge Planning Optimizer API computes optimized charging schedules
    for electric fleets based on vehicle availability, energy demand, and
    infrastructure constraints.  
    It can generate OCPP-compatible Smart Charging Profiles (SCP) for direct
    dispatch to charge points and supports live, event-driven optimization.

servers:
  - url: https://api.avalon-cloud.de/optimizer/v1
    description: Non-productive

tags:
  - name: Optimization
    description: Endpoints for charging plan optimization
  - name: SmartChargeControl
    description: Endpoints for generating power-optimized Smart Charging Profiles (SCP) and live control

paths:
  /charge-planning:
    post:
      summary: Optimize fleet charging plans
      description: >
        Computes optimized start/end times, EVSE assignments, and optionally
        detailed smart charging profiles for the provided tours.
      tags: [Optimization]
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChargePlanningRequest"
            examples:
              default:
                summary: Example request
                value:
                  companyId: avalon_transportation
                  locationId: aschaffenburg
                  returnOptimizedProfiles: true
                  cluster:
                    id: cluster_01
                    maxLimit: 800000
                  chargePoints:
                    - id: cp_01
                      fullName: Charger North
                      maxLimit: 320000
                    - id: cp_02
                      fullName: Charger South
                      maxLimit: 220000
                  evses:
                    - id: evse_01
                      cpId: cp_01
                      cpName: Charger North
                      fullName: Charger North - Socket A
                      maxLimit: 160000
                      maxCurrentLimit: 250
                    - id: evse_02
                      cpId: cp_01
                      cpName: Charger North
                      fullName: Charger North - Socket B
                      maxLimit: 160000
                      maxCurrentLimit: 250
                  tours:
                    - id: 91Ov9Uj7h-vxokQWXuMJm
                      priority: 2
                      energyDemand: 96.69
                      fromDay: THURSDAY
                      fromTime: "15:00"
                      endDay: TUESDAY
                      endTime: "17:00"
                      vehicle:
                        id: vYbisDjeZFFcYyx0yogX
                        key: AB-TG-2000
                        idTag: 01F2AE40110189
                        capacity: 621
                        avgChaPower: 260000
                        thresholdEnergy: 600
                        reducedChaPower: 70000
                        systemVoltage: 800
                        maxChaPower: 400000
                        minChaPower: 0
      responses:
        "200":
          description: Optimization successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChargePlanningResponse"
              examples:
                withProfiles:
                  summary: Example with smartChargingProfile
                  value:
                    status: success
                    optimizedTours:
                      - id: 91Ov9Uj7h-vxokQWXuMJm
                        recommendedStartDay: THURSDAY
                        recommendedStartTime: "20:00"
                        recommendedEndDay: FRIDAY
                        recommendedEndTime: "03:30"
                        recommendedTargetSoc: 0.8
                        cp: cp_01
                        evse: evse_01
                        smartChargingProfile:
                          - time: 0
                            power: 123313
                          - time: 4500
                            power: 94971
                          - time: 11100
                            power: 92910
                          - time: 16200
                            power: 0
                    clusterLoadProfile:
                      - timestamp: "2025-10-06T20:00:00Z"
                        power: 180000
                      - timestamp: "2025-10-06T20:05:00Z"
                        power: 190000
        "400":
          description: Bad request – invalid or missing parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden – invalid API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /smart-charge-control:
    post:
      summary: Generate Smart Charge Control Profiles
      description: >
        Computes optimized Smart Charging Profiles for a given set of tours (charging sessions)
        based on infrastructure limits and the selected optimization mode (price-optimized or load-optimized).
        Each profile represents a power-vs-time schedule suitable for OCPP-compatible dispatch.
        If a tour's startSoc is omitted or zero, a default of 0.2 (20%) is assumed.
      tags: [SmartChargeControl]
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SmartChargeControlRequest"
            examples:
              default:
                summary: Example request
                value:
                  companyId: avalon_transportation
                  locationId: aschaffenburg
                  optimizationMode: price
                  cluster:
                    id: cluster_01
                    maxLimit: 800000
                  chargePoints:
                    - id: cp_01
                      fullName: Charger North
                      maxLimit: 320000
                    - id: cp_02
                      fullName: Charger South
                      maxLimit: 220000
                  evses:
                    - id: evse_01
                      cpId: cp_01
                      cpName: Charger North
                      fullName: Charger North - Socket A
                      maxLimit: 160000
                      maxCurrentLimit: 250
                    - id: evse_02
                      cpId: cp_02
                      cpName: Charger South
                      fullName: Charger South - Socket A
                      maxLimit: 110000
                      maxCurrentLimit: 160
                  tours:
                    - id: tour_01
                      recommendedStartDay: THURSDAY
                      recommendedStartTime: "20:00"
                      recommendedEndDay: FRIDAY
                      recommendedEndTime: "03:30"
                      startSoc: 0.2
                      targetSoc: 0.8
                      vehicle:
                        id: vYbisDjeZFFcYyx0yogX
                        key: AB-TG-2000
                        idTag: 01F2AE40110189
                        capacity: 621
                        avgChaPower: 260000
                        maxChaPower: 400000
                        minChaPower: 0
                        thresholdEnergy: 600
                        reducedChaPower: 70000
                        systemVoltage: 800
                      cp: cp_01
                      evse: evse_01
      responses:
        "200":
          description: Smart Charge Control optimization successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SmartChargeControlResponse"
              examples:
                success:
                  summary: Example response
                  value:
                    status: success
                    profiles:
                      - tourId: tour_01
                        cp: cp_01
                        evse: evse_01
                        smartChargingProfile:
                          - time: 0
                            power: 120000
                          - time: 300
                            power: 90000
                          - time: 600
                            power: 60000
                          - time: 900
                            power: 0
                    clusterLoadProfile:
                      - timestamp: "2025-10-28T20:00:00Z"
                        power: 180000
                      - timestamp: "2025-10-28T20:05:00Z"
                        power: 190000
        "400":
          description: Bad request – invalid or missing parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden – invalid API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /smart-charge-control/snapshot:
    post:
      summary: Live optimization snapshot (batch of Start/Ongoing/Stop)
      description: >
        Accepts a snapshot of all currently relevant sessions (transactions) for a given location/cluster
        with per-item status `Start | Ongoing | Stop`. The server merges this snapshot with its internal plan
        and live-block, resolves vehicles and tours as needed, and computes Smart Charging Profiles (SCP)
        for all `Start` and `Ongoing` sessions atomically.  
        Infrastructure objects (cluster/CPs/EVSEs) are **optional** in the request if they are already
        configured in the provider's system. If omitted and the server cannot resolve the infrastructure
        consistently, it returns an error per affected item with `resultStatus = "infra_missing"`.
      tags: [SmartChargeControl]
      security:
        - ApiKeyAuth: []
      parameters:
        - in: header
          name: X-Snapshot-Timestamp
          required: false
          description: Optional UTC timestamp of the snapshot used for idempotency and ordering.
          schema:
            type: string
            format: date-time
        - in: header
          name: X-Idempotency-Key
          required: false
          description: Optional idempotency key for safe retries (e.g., hash of locationId + timestamp).
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LiveOptimizationSnapshotRequest"
            examples:
              fullSnapshot:
                summary: Full snapshot with Start/Ongoing/Stop
                value:
                  companyId: avalon_transportation
                  locationId: aschaffenburg
                  optimizationMode: price
                  cluster:
                    id: cluster_01
                    maxLimit: 800000
                  chargePoints:
                    - id: cp_01
                      fullName: Charger North
                      maxLimit: 320000
                  evses:
                    - id: evse_01
                      cpId: cp_01
                      cpName: Charger North
                      fullName: Socket A
                      maxLimit: 160000
                      maxCurrentLimit: 250
                  payloadMode: full_snapshot
                  sessions:
                    - status: Start
                      transactionId: tx_9001
                      idTag: 01F2AE40110189
                      cp: cp_01
                      evse: evse_01
                      soc: 0.32
                      timestamp: "2025-10-29T12:05:00Z"
                    - status: Ongoing
                      transactionId: tx_8123
                      cp: cp_01
                      evse: evse_01
                      soc: 0.54
                      timestamp: "2025-10-29T12:05:00Z"
                    - status: Stop
                      transactionId: tx_7007
                      timestamp: "2025-10-29T12:04:00Z"
              ongoingOnly:
                summary: Ongoing-only snapshot
                value:
                  companyId: avalon_transportation
                  locationId: aschaffenburg
                  payloadMode: ongoing_only
                  optimizationMode: load
                  sessions:
                    - status: Ongoing
                      transactionId: tx_8123
                      cp: cp_01
                      evse: evse_01
                      soc: 0.54
                      timestamp: "2025-10-29T12:05:00Z"
      responses:
        "200":
          description: Live optimization performed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LiveOptimizationResponse"
              examples:
                example:
                  summary: Example response with mixed results
                  value:
                    status: success
                    results:
                      - transactionId: tx_9001
                        tourId: tour_01
                        cp: cp_01
                        evse: evse_01
                        resultStatus: ok
                        smartChargingProfile:
                          - time: 0
                            power: 120000
                          - time: 300
                            power: 90000
                          - time: 600
                            power: 60000
                          - time: 900
                            power: 0
                      - transactionId: tx_8123
                        tourId: tour_05
                        cp: cp_01
                        evse: evse_01
                        resultStatus: ok
                        smartChargingProfile: []
                      - transactionId: tx_7007
                        resultStatus: stopped
                      - transactionId: tx_9999
                        resultStatus: infra_missing
                        message: EVSE not found in provider configuration
                    clusterLoadProfile:
                      - timestamp: "2025-10-29T12:05:00Z"
                        power: 180000
                      - timestamp: "2025-10-29T12:10:00Z"
                        power: 190000
        "400":
          description: Bad request – invalid or missing parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden – invalid API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Unprocessable – infrastructure could not be resolved from server-side config
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: API key required for authentication and authorization.

  schemas:
    ChargePlanningRequest:
      type: object
      required:
        - companyId
        - locationId
        - cluster
        - chargePoints
        - evses
        - tours
      properties:
        companyId:
          type: string
          description: Unique identifier of the company performing the optimization.
        locationId:
          type: string
          description: Unique identifier of the physical depot or site.
        returnOptimizedProfiles:
          type: boolean
          description: >
            If true, the optimizer will return for each tour a `smartChargingProfile`
            array showing detailed time–power pairs suitable for OCPP dispatch.
          default: false
        cluster:
          $ref: "#/components/schemas/Cluster"
        chargePoints:
          type: array
          description: List of charge points (stations) available for optimization.
          items:
            $ref: "#/components/schemas/ChargePoint"
        evses:
          type: array
          description: List of EVSE connectors associated with the charge points.
          items:
            $ref: "#/components/schemas/EVSE"
        tours:
          type: array
          description: List of all vehicle tours to be optimized.
          items:
            $ref: "#/components/schemas/Tour"

    Cluster:
      type: object
      required: [id, maxLimit]
      properties:
        id:
          type: string
          description: Unique cluster identifier.
        maxLimit:
          type: number
          description: Maximum power capacity of the cluster in watts.

    ChargePoint:
      type: object
      required: [id, fullName, maxLimit]
      properties:
        id:
          type: string
          description: Unique charge point (station) identifier.
        fullName:
          type: string
          description: Human-readable charge point name.
        maxLimit:
          type: number
          description: Maximum total charger power limit in watts.

    EVSE:
      type: object
      required: [id, cpId, cpName, fullName, maxLimit, maxCurrentLimit]
      properties:
        id:
          type: string
          description: Unique EVSE identifier (individual connector).
        cpId:
          type: string
          description: Identifier of the parent charge point this EVSE belongs to.
        cpName:
          type: string
          description: Name of the parent charge point.
        fullName:
          type: string
          description: Human-readable name for the EVSE (e.g. station + socket name).
        maxLimit:
          type: number
          description: Maximum power limit for the EVSE in watts.
        maxCurrentLimit:
          type: number
          description: Maximum current (in amperes) that can be delivered by this EVSE.

    Tour:
      type: object
      required:
        - id
        - priority
        - energyDemand
        - fromDay
        - fromTime
        - endDay
        - endTime
        - vehicle
      properties:
        id:
          type: string
          description: Unique identifier of the tour or charging session.
        priority:
          type: number
          description: Numeric priority level (higher = more important).
        energyDemand:
          type: number
          description: Required energy demand for the vehicle in kWh.
        fromDay:
          type: string
          description: Earliest weekday when the vehicle is available for charging.
        fromTime:
          type: string
          description: Earliest start time of availability (HH:MM, 24-hour format).
        endDay:
          type: string
          description: Latest weekday when the charging must be completed.
        endTime:
          type: string
          description: Latest end time of availability (HH:MM, 24-hour format).
        vehicle:
          $ref: "#/components/schemas/Vehicle"

    Vehicle:
      type: object
      required:
        - id
        - key
        - idTag
        - capacity
        - avgChaPower
        - maxChaPower
        - minChaPower
        - thresholdEnergy
        - reducedChaPower
        - systemVoltage
      properties:
        id:
          type: string
          description: Unique identifier of the vehicle.
        key:
          type: string
          description: Vehicle license plate or internal key.
        idTag:
          type: string
          description: RFID or authorization identifier used at the charge point.
        capacity:
          type: number
          description: Battery capacity in kilowatt-hours.
        avgChaPower:
          type: number
          description: Average charging power in watts.
        maxChaPower:
          type: number
          description: Maximum charging power the vehicle supports in watts.
        minChaPower:
          type: number
          description: Minimum charging power the vehicle can sustain in watts.
        thresholdEnergy:
          type: number
          description: Energy threshold (in kWh) after which reduced power is applied.
        reducedChaPower:
          type: number
          description: Reduced charging power (in watts) applied beyond the threshold.
        systemVoltage:
          type: number
          description: Nominal DC system voltage of the battery.

    ChargePlanningResponse:
      type: object
      properties:
        status:
          type: string
          enum: [success, error]
          description: Processing status of the optimization.
        optimizedTours:
          type: array
          description: List of tours with assigned start/end times and EVSEs.
          items:
            $ref: "#/components/schemas/OptimizedTour"
        clusterLoadProfile:
          type: array
          description: Optional array describing total cluster power load over time.
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
                description: Timestamp (UTC) for this power measurement.
              power:
                type: number
                description: Total site power draw in watts at the given time.
        errorMessage:
          type: string
          description: Human-readable error message, present only when status = error.

    OptimizedTour:
      type: object
      properties:
        id:
          type: string
          description: Identifier of the optimized tour.
        recommendedStartDay:
          type: string
          description: Recommended weekday to begin charging.
        recommendedStartTime:
          type: string
          description: Recommended start time for charging (HH:MM).
        recommendedEndDay:
          type: string
          description: Recommended weekday to finish charging.
        recommendedEndTime:
          type: string
          description: Recommended end time for charging (HH:MM).
        recommendedTargetSoc:
          type: number
          description: Optional target state of charge (fraction between 0 and 1).
        cp:
          type: string
          description: Assigned charge point ID.
        evse:
          type: string
          description: Assigned EVSE ID.
        smartChargingProfile:
          type: array
          description: >
            Optional OCPP-compatible smart charging profile showing
            time–power mapping for the recommended charging period.
          items:
            type: object
            properties:
              time:
                type: number
                description: Elapsed time since charging start in seconds.
              power:
                type: number
                description: Charging power in watts at that time.

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Description of the error that occurred.

    SmartChargeControlRequest:
      type: object
      required:
        - companyId
        - locationId
        - optimizationMode
        - tours
      properties:
        companyId:
          type: string
          description: Unique company identifier.
        locationId:
          type: string
          description: Location or depot identifier.
        optimizationMode:
          type: string
          enum: [price, load]
          description: Optimization strategy ("price" for cost minimization, "load" for peak reduction).
        cluster:
          $ref: "#/components/schemas/Cluster"
        chargePoints:
          type: array
          items:
            $ref: "#/components/schemas/ChargePoint"
        evses:
          type: array
          items:
            $ref: "#/components/schemas/EVSE"
        tours:
          type: array
          items:
            $ref: "#/components/schemas/TourForSmartChargeControl"

    TourForSmartChargeControl:
      type: object
      required:
        - id
        - recommendedStartDay
        - recommendedStartTime
        - recommendedEndDay
        - recommendedEndTime
        - targetSoc
        - vehicle
        - cp
        - evse
      properties:
        id:
          type: string
          description: Unique tour or session identifier.
        recommendedStartDay:
          type: string
          description: Planned weekday to begin charging.
        recommendedStartTime:
          type: string
          description: Planned start time (HH:MM).
        recommendedEndDay:
          type: string
          description: Planned weekday to finish charging.
        recommendedEndTime:
          type: string
          description: Planned end time (HH:MM).
        startSoc:
          type: number
          description: Starting state of charge (0–1). Defaults to 0.2 if not provided.
        targetSoc:
          type: number
          description: Desired state of charge at session end (0–1).
        vehicle:
          $ref: "#/components/schemas/Vehicle"
        cp:
          type: string
          description: Assigned charge point ID.
        evse:
          type: string
          description: Assigned EVSE ID.

    SmartChargeControlResponse:
      type: object
      properties:
        status:
          type: string
          enum: [success, error]
        profiles:
          type: array
          description: Generated Smart Charging Profiles for each tour.
          items:
            type: object
            properties:
              tourId:
                type: string
              cp:
                type: string
                description: Charge point identifier.
              evse:
                type: string
                description: EVSE identifier.
              smartChargingProfile:
                type: array
                description: Time–power mapping for the tour.
                items:
                  type: object
                  properties:
                    time:
                      type: number
                      description: Elapsed time in seconds since start.
                    power:
                      type: number
                      description: Power in watts at that time.
        clusterLoadProfile:
          type: array
          description: Aggregated cluster power profile (optional).
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
                description: UTC timestamp.
              power:
                type: number
                description: Total cluster power in watts.
        errorMessage:
          type: string
          description: Error details if `status = error`.

    LiveOptimizationSnapshotRequest:
      type: object
      required:
        - companyId
        - locationId
        - sessions
      properties:
        companyId:
          type: string
          description: Unique company identifier.
        locationId:
          type: string
          description: Location or depot identifier.
        optimizationMode:
          type: string
          enum: [price, load]
          description: Optional override; if omitted, server uses location default.
        payloadMode:
          type: string
          enum: [full_snapshot, ongoing_only]
          description: >
            Indicates whether the payload lists all relevant sessions (full_snapshot) or only ongoing ones.
            Missing sessions in `ongoing_only` are not interpreted as stopped.
        cluster:
          $ref: "#/components/schemas/Cluster"
        chargePoints:
          type: array
          items:
            $ref: "#/components/schemas/ChargePoint"
        evses:
          type: array
          items:
            $ref: "#/components/schemas/EVSE"
        sessions:
          type: array
          minItems: 1
          items:
            oneOf:
              - $ref: "#/components/schemas/LiveStartSessionItem"
              - $ref: "#/components/schemas/LiveOngoingSessionItem"
              - $ref: "#/components/schemas/LiveStopSessionItem"

    LiveStartSessionItem:
      type: object
      required: [status, transactionId, idTag, cp, evse, timestamp]
      properties:
        status:
          type: string
          enum: [Start]
        transactionId:
          type: string
        idTag:
          type: string
        cp:
          type: string
        evse:
          type: string
        soc:
          type: number
          description: State of charge (0–1). If omitted, server uses 0.2 default for energy calc.
        timestamp:
          type: string
          format: date-time

    LiveOngoingSessionItem:
      type: object
      required: [status, transactionId, cp, evse, soc, timestamp]
      properties:
        status:
          type: string
          enum: [Ongoing]
        transactionId:
          type: string
        cp:
          type: string
        evse:
          type: string
        soc:
          type: number
          description: State of charge (0–1).
        timestamp:
          type: string
          format: date-time

    LiveStopSessionItem:
      type: object
      required: [status, transactionId, timestamp]
      properties:
        status:
          type: string
          enum: [Stop]
        transactionId:
          type: string
        timestamp:
          type: string
          format: date-time

    LiveOptimizationResponse:
      type: object
      properties:
        status:
          type: string
          enum: [success, error]
        results:
          type: array
          items:
            $ref: "#/components/schemas/LiveOptimizationResultItem"
        clusterLoadProfile:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              power:
                type: number
        errorMessage:
          type: string

    LiveOptimizationResultItem:
      type: object
      properties:
        transactionId:
          type: string
        tourId:
          type: string
          description: Linked tour/session identifier if available.
        cp:
          type: string
        evse:
          type: string
        resultStatus:
          type: string
          enum: [ok, stopped, no_plan, unknown_idTag, unknown_transaction, ignored_non_planned, infeasible, infra_missing]
        message:
          type: string
        smartChargingProfile:
          type: array
          items:
            type: object
            properties:
              time:
                type: number
                description: Elapsed time in seconds since start.
              power:
                type: number
                description: Power in watts at that time.
